<link href="./css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
 <script src="./js/bootstrap.min.js" crossorigin="anonymous"></script>

 <div id="main" data-bs-theme="dark">
   <div class="card">

     <div class="card-header" id="uiButtons">
       <h5 class="mb-0 text-center">
         <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#discoverDevices"
           aria-expanded="false" aria-controls="discoverDevices" style="border: 0;">
           Discover devices
         </button>
       </h5>
     </div>

     <div class="collapse" id="discoverDevices">
       <div class="card-body">
         <form>
           <div class="mb-3" id="login">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
             <input type="email" class="form-control" id="username" placeholder="your@email.com" required>
           </div>
           <div class="mb-3">
             <label for="password" class="form-label">Password</label>
             <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3">
              <label for="region" class="form-label">Region</label>
              <select class="form-select" id="region">
                <option value="Default (all other regions)">Default (all other regions)</option>
                <option value="Australia">Australia</option>
                <option value="China">China</option>
                <option value="Russia">Russia</option>
                <option value="USA">USA/Canada</option>
              </select>
           </div>
           <button class="btn btn-primary btn-login" type="submit" id="discoverBtn" style="border: 0;">
            Discover Devices on account
          </button>
          </div>
        </form>
        <div class="text-center device-table" style="display: none" id="discoverTableWrapper">
          <table class="table table-sm" id="discoverTable">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Id</th>
                <th scope="col">Mac</th>
                <th scope="col">Add&nbsp;/&nbsp;Update</th>
              </tr>
            </thead>
             <tbody>
               <tr>
                 <td>No devices found!</td>
               </tr>
             </tbody>
           </table>
         </div>
       </div>
     </div>
   </div>

 </div>

 <style>

  .hide {
    display: none;
  }

  .disabled {
    pointer-events: none;
    opacity: 0.5;
  }
</style>


<script>

  (async () => {
    /*********************************************************************
     * Initialize Javascript supporting code
     */
    const REQUEST_TIMEOUT_MS = 15000;
    const withTimeout = (promise, label) => {
      let timeoutId;
      const timeout = new Promise((_, reject) => {
        timeoutId = setTimeout(() => {
          reject(new Error(`${label} timed out after ${Math.round(REQUEST_TIMEOUT_MS / 1000)}s`));
        }, REQUEST_TIMEOUT_MS);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(timeoutId));
    };

    window.addEventListener('error', (event) => {
      try {
        homebridge.hideSpinner();
        homebridge.toast.error(`UI error: ${event.message || 'Unknown error'}`);
      } catch {
        // no-op
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      try {
        homebridge.hideSpinner();
        const reason = event.reason instanceof Error ? event.reason.message : String(event.reason);
        homebridge.toast.error(`UI error: ${reason}`);
      } catch {
        // no-op
      }
    });

    //homebridge.showSpinner();

    try {
      const { defaultConfig, defaultDeviceConfig } = await withTimeout(
        homebridge.request('/getDefaults'),
        'Loading defaults'
      );
      const pluginConfig = await withTimeout(
        homebridge.getPluginConfig(),
        'Loading plugin config'
      );
      const configSchema = await withTimeout(
        homebridge.getPluginConfigSchema(),
        'Loading config schema'
      );

      if (!pluginConfig.length) {
        pluginConfig.push({});
      }
      let configuration = pluginConfig[0];

      // Helper funcion to contol debug messages
      function debugLog(s) {
        if (configuration.uiDebug) {
          console.debug(s);
        }
      }

      debugLog(`Plugin Config:\n${JSON.stringify(configuration, null, 2)}`);
      configuration = await withTimeout(
        homebridge.request('/mergeToDefault', { config: configuration }),
        'Merging config defaults'
      );

      /*********************************************************************
       * showToast event listener
       * Provides information from server-side to the end user.
       */
      homebridge.addEventListener('showToast', (event) => {
        debugLog(`showToast Received: ${JSON.stringify(event.data)}`);
        if (event.data.success) {
          homebridge.toast.success(event.data.msg);
        } else {
          homebridge.toast.error(event.data.msg);
        }
      });

    /*********************************************************************
     * filterOutDefaults
     * returns object for config.json that has default values removed
     */
    function filterOutDefaults(object, defaults) {

      function deleteEmptyObjects(object) {
        for (const [k, v] of Object.entries(object)) {
          if (!v || typeof v !== 'object' || v === null) {
            continue;
          }
          deleteEmptyObjects(v);
          if (Object.keys(v).length === 0) {
            delete object[k];
          }
        }
        return object;
      }

      let newObject = {};
      for (const [k, v] of Object.entries(object)) {
        if (k === 'devices') {
          newObject[k] = v.map((device) => {
            return filterOutDefaults(device, defaultDeviceConfig);
          });
        } else if (typeof v === 'object' && v !== null) {
          newObject[k] = filterOutDefaults(v, defaults[k]);
        } else if (typeof defaults === 'object' && k in defaults && v === defaults[k]) {
          continue;
        } else {
          newObject[k] = v;
        }
      }
      return deleteEmptyObjects(newObject);
    }

    /*********************************************************************
     * createForm
     * Update the plugin config GUI. Does not save to config.json
     */
    function createForm(configSchema, configuration) {
      const configForm = homebridge.createForm(configSchema, configuration);
      configForm.onChange(async (changes) => {
        changes = filterOutDefaults(changes, defaultConfig);
        debugLog(`[createForm] Config changes:\n${JSON.stringify(changes, null, 2)}`);
        await homebridge.updatePluginConfig([changes]);
      });
    }

      createForm(configSchema, configuration);
      
      // If configuration already has credentials, collapse the discover section
      if (configuration.username && configuration.accountUuid) {
        const discoverBtn = document.getElementById('discoverBtn');
        const discoverSection = document.getElementById('discoverDevices');
        const collapseInstance = new bootstrap.Collapse(discoverSection, {
          toggle: true
        });
      }

    /*********************************************************************
     * Discover button clicked....
     */
      document.getElementById('discoverBtn').addEventListener('click', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const region = document.getElementById('region').value;
      const discoverBtn = document.getElementById('discoverBtn');

      // Validate inputs
      if (!username || !password) {
        homebridge.toast.error('Please enter both username and password');
        return;
      }

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(username)) {
        homebridge.toast.error('Please enter a valid email address');
        return;
      }

      // Disable button during discovery
      discoverBtn.disabled = true;
      const originalText = discoverBtn.textContent;
      discoverBtn.textContent = 'Discovering...';

      homebridge.showSpinner();

      try {
         const devices = await withTimeout(
           homebridge.request('/discover', { username, password, region }),
           'Discovering devices'
         );
         debugLog(`Discovered devices:\n${JSON.stringify(devices, null, 2)}`);
         
         if (!devices || devices.length === 0) {
           homebridge.toast.error('No devices found on this account');
           homebridge.hideSpinner();
           discoverBtn.disabled = false;
           discoverBtn.textContent = originalText;
           return;
         }
         
         const table = document.getElementById('discoverTable').getElementsByTagName('tbody')[0];
         table.innerHTML = '';

         // Merge current config over to the server so discover has latest device config...
         let currentConfig = await homebridge.getPluginConfig();
         currentConfig = currentConfig.length > 0 ? currentConfig[0] : {};
         configuration = await withTimeout(
           homebridge.request('/mergeToDefault', { config: currentConfig }),
           'Merging config defaults'
         );

         currentConfig.devices = currentConfig.devices || [];
         
         const accountUuid = devices[0].name;
         
         if (!accountUuid) {
           throw new Error('Could not determine account UUID from devices');
         }

         configuration.username = username;
         configuration.password = password;
         configuration.region = region;
         configuration.accountUuid = accountUuid;

         const initialStates = await withTimeout(
           homebridge.request('/getInitialDeviceStates', { accountUuid, uuids: devices.map((d) => d.uuid) }),
           'Loading device states'
         );

         devices.forEach((device) => {
           const state = initialStates.find((s) => s.id === device.uuid);
           if (!state) {
             debugLog(`Warning: No state found for device ${device.uuid}`);
             return;
           }
           
           const tr = table.insertRow();
           const td = tr.insertCell();
           td.appendChild(document.createTextNode(state.name));
           td.setAttribute('scope', 'row');

           tr.insertCell().appendChild(document.createTextNode(device.uuid));
           tr.insertCell().appendChild(document.createTextNode(device.mac || 'N/A'));

           const addCell = tr.insertCell();
           if (currentConfig.devices.find((d) => d.id === device.uuid)) {
             addCell.appendChild(document.createTextNode('Already added'));
           } else {
             // No record for this device, add button to add it.
             const button = document.createElement('button');
             button.innerText = 'Add';
             button.className = 'btn btn-secondary btn-sm';
             button.addEventListener('click', async () => {
               // Add button clicked...
               const newDevice = {
                 id: device.uuid,
                 name: state.name
               };

               configuration.devices.push({
                 ...defaultDeviceConfig,
                 ...newDevice
               });
               debugLog(`Adding new device:\n${JSON.stringify({ ...defaultDeviceConfig, ...newDevice }, null, 2)}`);
               // refresh view
               createForm(configSchema, configuration);

               addCell.removeChild(button);
               addCell.appendChild(document.createTextNode('Added'));

               homebridge.toast.success('Device added');
             });
             addCell.appendChild(button);
           }
         });
         
         document.getElementById('discoverTableWrapper').style.display = 'block';
         homebridge.toast.success(`Found ${devices.length} device(s)`);

      } catch (e) {
        const errorMsg = e instanceof Error ? e.message : String(e);
        homebridge.toast.error(`Discovery failed: ${errorMsg}`);
      } finally {
        homebridge.hideSpinner();
        discoverBtn.disabled = false;
        discoverBtn.textContent = originalText;
      }

      });
    } catch (e) {
      const errorMsg = e instanceof Error ? e.message : String(e);
      console.error(e);
      homebridge.toast.error(`UI init failed: ${errorMsg}`);
    } finally {
      homebridge.hideSpinner();
    }
  })();

</script>
